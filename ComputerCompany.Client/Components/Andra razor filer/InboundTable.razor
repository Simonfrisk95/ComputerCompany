@using ShoeCompany.Shared.DTO

<div class="table-responsive">
  <table class="table table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th style="width:6%">Id</th>
        <th>Supplier</th>
        <th style="width:16%">Received</th>
        <th style="width:18%">Items</th>
        <th class="text-end" style="width:16%">Actions</th>
      </tr>
    </thead>

    <tbody>
      @if (Items?.Any() == true)
      {
        @foreach (var r in Items)
        {
          <tr>
            <td>@r.Id</td>
            <td>@r.Supplier</td>

            <td>
              @{
                var received = (DateTime?)null;
                received ??= r.Received;
              }
              @received?.ToString("yyyy-MM-dd")
            </td>

            <td>
              <span class="badge bg-secondary me-2">@((r.Items?.Count) ?? 0)</span>
              <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => Toggle(r.Id)">
                @(expandedId == r.Id ? "Hide" : "View Details")
              </button>
            </td>

            <td class="text-end text-nowrap">
              <button class="btn btn-sm btn-danger" @onclick="() => OnDelete.InvokeAsync(r)">Delete</button>
            </td>
          </tr>

          @if (expandedId == r.Id)
          {
            <tr class="table-light">
              <td colspan="5">
                @if (r.Items?.Any() == true)
                {
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead>
                        <tr>
                          <th style="width:10%">ProductId</th>
                          <th style="width:18%">SKU</th>
                          <th>Name</th>
                          <th style="width:15%">Location</th>
                          <th style="width:10%" class="text-end">Quantity</th>
                        </tr>
                      </thead>
                      <tbody>
                        @foreach (var it in r.Items)
                        {
                          <tr>
                            <td>@it.ProductId</td>
                            <td>@it.SKU</td>
                            <td>@it.Name</td>
                            <td>@it.Location</td>
                            <td class="text-end">@it.Quantity</td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                }
                else
                {
                  <div class="text-muted">No items.</div>
                }
              </td>
            </tr>
          }
        }
      }
      else
      {
        <tr>
          <td colspan="5" class="text-center text-muted py-4">No inbounds found.</td>
        </tr>
      }
    </tbody>
  </table>
</div>

<div class="d-flex justify-content-end align-items-center mt-2">
  <nav>
    <ul class="pagination mb-0">
      <li class="page-item @(Skip == 0 ? "disabled" : "")">
        <button class="page-link" @onclick="Prev">Previous</button>
      </li>
      <li class="page-item disabled">
        <span class="page-link">
          Page @((Skip / Take) + 1) of @Math.Max(1, (int)Math.Ceiling((double)Total / Take))
        </span>
      </li>
      <li class="page-item @(Skip + Take >= Total ? "disabled" : "")">
        <button class="page-link" @onclick="Next">Next</button>
      </li>
    </ul>
  </nav>
</div>

@code {
  // INPUTS
  [Parameter] public IReadOnlyList<InboundDetailsDto> Items { get; set; } = Array.Empty<InboundDetailsDto>();
  [Parameter] public int Total { get; set; }
  [Parameter] public int Skip { get; set; }
  [Parameter] public int Take { get; set; } = 10;

  // EVENTS
  [Parameter] public EventCallback<InboundDetailsDto> OnDelete { get; set; }
  [Parameter] public EventCallback<(int skip, int take)> OnPageChange { get; set; }

  // LOCAL STATE
  private int? expandedId;

  /// <summary>
  /// Shows or hides the details row for the given inbound Id.
  /// Clicking the same Id again collapses it.
  /// </summary>
  /// <param name="id">The inbound Id to toggle.</param>
  /// <returns>Nothing.</returns>
  private void Toggle(int id) => expandedId = expandedId == id ? null : id;

  /// <summary>
  /// Moves to the previous page (clamped at 0) and notifies the parent via <see cref="OnPageChange"/>.
  /// </summary>
  /// <returns>A task that finishes after the parent handles paging.</returns>
  private Task Prev() => OnPageChange.InvokeAsync((Math.Max(0, Skip - Take), Take));

  /// <summary>
  /// Moves to the next page (clamped at the end) and notifies the parent via <see cref="OnPageChange"/>.
  /// </summary>
  /// <returns>A task that finishes after the parent handles paging.</returns>
  private Task Next()
  {
    var newSkip = Math.Min(Skip + Take, Math.Max(0, Total - 1));
    return OnPageChange.InvokeAsync((newSkip, Take));
  }
  
}