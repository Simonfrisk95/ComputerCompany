@page "/adminpanel"
@inject UserApi UserApi
@using ShoeCompany.Shared.DTO
@rendermode InteractiveWebAssembly
@inject IJSRuntime JS

@attribute [Authorize(Roles = "Admin")]

<h3>Users Management</h3>

<div class="d-flex justify-content-end mb-3">
    <button class="btn btn-success" @onclick="ShowCreateModal">
        + Create User
    </button>
</div>

<div class="mb-3">
    <input type="text" class="form-control" placeholder="Search by name or email..."
           @bind="SearchText" @bind:event="oninput" />
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Avatar</th>
            <th>Display Name</th>
            <th>Email</th>
            <th>Roles</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Users != null)
        {
            @foreach (var user in FilteredUsers)
            {
                <tr>
                    <td>
                        <img src="@GetRandomAvatar(user.Email)" alt="Avatar" class="rounded-circle" style="width:40px; height:40px;" />
                    </td>
                    <td>@user.DisplayName</td>
                    <td>@user.Email</td>
                    <td>@string.Join(", ", user.Roles)</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" @onclick="() => ShowEditModal(user)">Edit</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteUser(user.Id)">Delete</button>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

@if (IsModalVisible)
{
    <div class="modal show d-block" tabindex="-1" @key="ModalKey">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@ModalTitle</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@FormModel" OnValidSubmit="SaveUser">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="form-floating mb-3">
                            <InputText class="form-control" @bind-Value="FormModel.DisplayName" placeholder="Display Name" />
                            <label>Display Name</label>
                        </div>

                        <div class="form-floating mb-3">
                            <InputText class="form-control" @bind-Value="FormModel.Email" placeholder="Email" />
                            <label>Email</label>
                        </div>

                        @if (IsCreating)
                        {
                            <div class="form-floating mb-3">
                                <InputText class="form-control" @bind-Value="FormModel.Password" placeholder="Password" type="password" />
                                <label>Password</label>
                            </div>
                        }

                        <div class="form-floating mb-3">
                            <InputText class="form-control" @bind-Value="FormModel.Roles" placeholder="Roles (comma separated)" />
                            <label>Roles (comma separated)</label>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-success">Save</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@code {
    private List<UserReadDto> Users = new();
    private bool IsModalVisible = false;
    private bool IsCreating = true;
    private string ModalTitle = "Create User";
    private string ModalKey = Guid.NewGuid().ToString();
    private string CurrentUserId = "";
    private string SearchText = "";

    // FormModel used for binding EditForm
    private FormData FormModel = new();

    // Filtered users based on search text
    private IEnumerable<UserReadDto> FilteredUsers =>
        string.IsNullOrWhiteSpace(SearchText)
            ? Users
            : Users.Where(u => u.DisplayName.Contains(SearchText, StringComparison.OrdinalIgnoreCase)
                            || u.Email.Contains(SearchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    // Load users from API
    private async Task LoadUsers()
    {
        var result = await UserApi.GetPagedAsync(0, 100);
        if (result != null)
        {
            Users = result.Items.ToList();
        }
    }

    // Show create modal
    private void ShowCreateModal()
    {
        IsCreating = true;
        ModalTitle = "Create User";
        CurrentUserId = "";
        FormModel = new FormData(); // clear previous input
        ModalKey = Guid.NewGuid().ToString();
        IsModalVisible = true;
    }

    // Show edit modal with user data
    private void ShowEditModal(UserReadDto user)
    {
        IsCreating = false;
        ModalTitle = "Edit User";
        CurrentUserId = user.Id;
        FormModel = new FormData
        {
            DisplayName = user.DisplayName,
            Email = user.Email,
            Roles = string.Join(", ", user.Roles),
            Password = "" // password not editable
        };
        ModalKey = Guid.NewGuid().ToString();
        IsModalVisible = true;
    }

    // Save user (create or update)
    private async Task SaveUser()
    {
        var roles = FormModel.Roles.Split(",", StringSplitOptions.RemoveEmptyEntries)
                                   .Select(r => r.Trim())
                                   .ToList();

        if (IsCreating)
        {
            var dto = new UserCreateDto
            {
                DisplayName = FormModel.DisplayName,
                Email = FormModel.Email,
                Password = FormModel.Password,
                Roles = roles
            };
            var created = await UserApi.CreateAsync(dto);
            if (created != null)
            {
                await UserApi.UpdateRolesAsync(created.Id, new UserRolesUpdateDto { Roles = roles });
                await LoadUsers();
            }
        }
        else
        {
            var dto = new UserUpdateDto
            {
                DisplayName = FormModel.DisplayName,
                Email = FormModel.Email
            };
            await UserApi.UpdateAsync(CurrentUserId, dto);
            await UserApi.UpdateRolesAsync(CurrentUserId, new UserRolesUpdateDto { Roles = roles });
            await LoadUsers();
        }

        CloseModal();
    }

    // Delete user with confirmation
    private async Task DeleteUser(string id)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this user?"))
        {
            await UserApi.DeleteAsync(id);
            await LoadUsers();
        }
    }

    // Close modal dialog
    private void CloseModal()
    {
        IsModalVisible = false;
    }
    
    // Setting random image as avatar based on email hash
    private string GetRandomAvatar(string email)
    {
        var avatars = new[]
        {
            "https://bootdey.com/img/Content/avatar/avatar1.png",
            "https://bootdey.com/img/Content/avatar/avatar2.png",
            "https://bootdey.com/img/Content/avatar/avatar3.png",
            "https://bootdey.com/img/Content/avatar/avatar4.png",
            "https://bootdey.com/img/Content/avatar/avatar5.png",
            "https://bootdey.com/img/Content/avatar/avatar6.png",
            "https://bootdey.com/img/Content/avatar/avatar7.png",
            "https://bootdey.com/img/Content/avatar/avatar8.png"
        };

        return string.IsNullOrWhiteSpace(email)
            ? avatars[0]
            : avatars[Math.Abs(email.GetHashCode()) % avatars.Length];
    }

    private class FormData
    {
        public string DisplayName { get; set; } = "";
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
        public string Roles { get; set; } = "";
    }
}
